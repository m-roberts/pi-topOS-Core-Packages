#!/bin/bash
###############################################################
#                Unofficial 'Bash strict mode'                #
# http://redsymbol.net/articles/unofficial-bash-strict-mode/  #
###############################################################
set -euo pipefail
IFS=$'\n\t'
###############################################################


produce_hostname() {
    local RPI_SERIAL;
    local RPI_ID;
    RPI_SERIAL=$(grep -e "Serial" /proc/cpuinfo | awk '{print $3}')
    RPI_SERIAL="${RPI_SERIAL:-12345678}"
    RPI_ID=$(echo "${RPI_SERIAL: -4}" | tr '[:lower:]' '[:upper:]')
    echo "pi-top-${RPI_ID}"
}


set_hostname() {
    local NEW_HOSTNAME;
    NEW_HOSTNAME="$1"
    echo "Setting hostname to '${NEW_HOSTNAME}'"

    # update hostname
    hostname "${NEW_HOSTNAME}"
    echo "${NEW_HOSTNAME}" > /etc/hostname

    # update /etc/hosts
    sed -i '/^127.0.1.1/d' /etc/hosts
    echo -e "127.0.1.1\tpi-top\t${NEW_HOSTNAME}" | tee -a /etc/hosts
}


main() {
    new_hostname=$(produce_hostname)
    if [ "${new_hostname}" != "$(hostname)" ]; then
        set_hostname "${new_hostname}"
    fi
}


main
